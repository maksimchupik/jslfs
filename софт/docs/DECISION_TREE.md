# Decision Tree для принятия решений

## Полный процесс принятия решения

```
Входящее сообщение
    │
    ├─→ [1] Парсинг контекста
    │   ├─ Извлечение текста, упоминаний, тона
    │   ├─ Определение темы
    │   └─ Проверка на вопрос
    │
    ├─→ [2] Проверка ограничений
    │   ├─ Автономность < 0.1? → IGNORE
    │   ├─ Запрещенная тема? → IGNORE
    │   ├─ Запрещенный пользователь? → IGNORE
    │   └─ Личность заблокирована? → Проверить можно ли менять
    │
    ├─→ [3] Проверка времени
    │   ├─ Активные часы? → Продолжить
    │   └─ Не активные часы? → DEFER
    │
    ├─→ [4] Проверка cooldown
    │   ├─ Прошло < 30 сек? → IGNORE
    │   └─ Прошло >= 30 сек? → Продолжить
    │
    ├─→ [5] Анализ важности
    │   ├─ Прямое упоминание? → +0.3
    │   ├─ Вопрос? → +0.15
    │   ├─ Релевантная тема? → +0.2
    │   ├─ Дружелюбный тон? → +0.1
    │   ├─ Спорный тон? → -0.3
    │   ├─ Недавно отвечал? → -0.2
    │   └─ Отношения с пользователем? → ±0.1
    │
    ├─→ [6] Расчет финального score
    │   score = base_probability + importance_adjustments
    │   score = clamp(score, 0.0, 1.0)
    │
    └─→ [7] Принятие решения
        ├─ score >= 0.5 → RESPOND
        │   ├─ Рассчитать задержку (30 сек - 2 часа)
        │   ├─ Построить промпт для LLM
        │   ├─ Сгенерировать ответ
        │   ├─ Применить стиль личности
        │   └─ Отправить сообщение
        │
        ├─ score >= 0.3 → REACT
        │   └─ Отреагировать (если поддерживается)
        │
        └─ score < 0.3 → IGNORE
            └─ Записать в лог
```

## Примеры сценариев

### Сценарий 1: Прямое упоминание

```
Сообщение: "@myaccount Привет, как дела?"
    │
    ├─ Парсинг: is_direct_mention = True, tone = "friendly"
    ├─ Важность: +0.3 (упоминание) + 0.1 (дружелюбный) = +0.4
    ├─ Score: 0.35 + 0.4 = 0.75
    └─ Решение: RESPOND (delay: 45 сек)
```

### Сценарий 2: Вопрос по интересной теме

```
Сообщение: "Что думаешь о новой технологии X?"
    │
    ├─ Парсинг: is_question = True, topic = "технологии" (в интересах)
    ├─ Важность: +0.15 (вопрос) + 0.2 (тема) = +0.35
    ├─ Score: 0.35 + 0.35 = 0.70
    └─ Решение: RESPOND (delay: 2 мин)
```

### Сценарий 3: Спорное сообщение

```
Сообщение: "Ты неправ, это глупо!"
    │
    ├─ Парсинг: tone = "argumentative"
    ├─ Важность: -0.3 (спорный тон)
    ├─ Score: 0.35 - 0.3 = 0.05
    └─ Решение: IGNORE (если discussion_tendency низкий)
```

### Сценарий 4: Недавно отвечал

```
Сообщение: "Еще один вопрос"
    │
    ├─ Парсинг: обычное сообщение
    ├─ Важность: 0.0 (базовая)
    ├─ Недавно отвечал: -0.2
    ├─ Score: 0.35 - 0.2 = 0.15
    └─ Решение: IGNORE
```

### Сценарий 5: Вне активных часов

```
Сообщение: "Привет!" (в 3 часа ночи)
    │
    ├─ Парсинг: обычное сообщение
    ├─ Проверка времени: не активные часы
    └─ Решение: DEFER (отложить до активных часов)
```

## Эволюция решений

После каждого взаимодействия личность эволюционирует:

- **RESPOND** → ↑ activity_level (+0.02)
- **DISCUSSION** → ↑ discussion_tendency (+0.04)
- **POSITIVE_REACTION** → ↑ activity_level (+0.03)
- **IGNORE** → ↓ activity_level (-0.01)

Изменения медленные и ограниченные, чтобы избежать резких скачков.

